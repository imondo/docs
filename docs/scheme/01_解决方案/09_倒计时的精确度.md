# 倒计时的精确度

<details>

<summary>查看代码</summary>





```js
/**
 * 
 * @param {number} timeStemp 倒计时时间撮
 * @param {number} delay 延时秒数
 * @param {number} init 是否自执行 默认 true
 * @param {Function} success 延时执行函数
 * @param {Function} complete 轮询执行完成后回调函数
 * 
 */
function CountdownUtil(options) {
  var _options = Object.assign({
    timeStemp,
    delay: 1000,
    init: true,
    success: null,
    complete: null
  }, options);

  var timeStemp = _options.timeStemp;
  var delay = _options.delay;

  var timer;
  var count = 0;
  var stop = true;
  var startTime;

  // 开始
  this.start = function() {
    stop = false;
    startTime = new Date().getTime();
    startCountDown(delay);
  }


  // 暂停
  this.stop = function() {
    if (!timer) {
      throw Error('当前定时器不存在');
    }
    stop = true;
  }

  // 清除倒计时
  this.clear = function() {
    stop = true;
    timer = null;
  }

  if (_options.init) {
    this.start();
  }

  var _this = this;
  function startCountDown(interval) {
    if (stop) {
      return;
    }
    timer = setTimeout(function() {
      clearTimeout(timer);
      
      // 倒计时还有多久结束
      var restTime = timeStemp - delay * count;
      var fomatTime = restTime;
      if (restTime < 0) {
        restTime = 0;
      }

      fomatTime = fomatTimeStemp(fomatTime);

      // 执行轮询回调
      _options.success && _options.success(Object.assign(fomatTime, { diff: restTime }));

      // 倒计时结束
      if (!restTime) {
        _this.clear();
        _options.complete && _options.complete();
        return;
      }

      count++;
      var endTime = new Date().getTime();

      // 当前差值 = 轮询的当前时间 - (最初时间 + 间隔时间 * 轮询次数)
      var diff = endTime - (startTime + delay * count);

      if (diff < 0) {
        diff = 0;
      }
      console.log(`diff: ${diff}`);
  
      startCountDown(delay - diff);
    }, interval);
  }

  function fomatTimeStemp(total) {
    const seconds = Math.floor( (total/1000) % 60 );
    const minutes = Math.floor( (total/1000/60) % 60 );
    const hours = Math.floor( (total/(1000*60*60)) % 24 );
    const days = Math.floor( total/(1000*60*60*24) );

    return {
      days,
      hours,
      minutes,
      seconds
    };
  }

  return this;

}
```

</details>