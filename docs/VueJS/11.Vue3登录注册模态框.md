# Vue3ç™»å½•æ³¨å†Œæ¨¡æ€æ¡†

> æºç ï¼š[åœ°å€](https://github.com/one-pupil/study/blob/master/vue_3.x/src/Login.vue)

å‰æ®µæ—¶é—´å†™ä¸‹çš„[Vue.extend ç™»å½•æ³¨å†Œæ¨¡æ€æ¡†](https://juejin.cn/post/6911209139834191886)æ˜¯åŸºäº Vue 2.x ä¸­ `Vue.extend` ç‰ˆæœ¬æ¥åš<br />![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a65c6a98eeae4d6a94938b020dfa397e~tplv-k3u1fbpfcp-zoom-1.image)<br />è€Œè¿™æ®µæ—¶é—´å†…éƒ½æ˜¯åœ¨å­¦ä¹  Vue 3.0 ä¸”ä¹Ÿå®Œå…¨é‡æ„äº†è¯¥é¡¹ç›®ï¼Œè®°å½•å­¦ä¹ ä¸‹é‡æ„çš„è¿‡ç¨‹ä¸æ€è€ƒã€‚<br />

<a name="AvWuL"></a>
## ç»„ä»¶
ç»„ä»¶è¿˜æ˜¯é‚£å‡ ä¸ªç»„ä»¶ï¼Œéœ€è¦æ”¹åŠ¨çš„åœ°æ–¹ä¸æ˜¯å¾ˆå¤šï¼Œåªæ˜¯æŠŠå…¶æ”¹æˆ Vue 3 çš„å½¢å¼<br />![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa2db2de4e9a4d10a17372aea63a6e7f~tplv-k3u1fbpfcp-zoom-1.image)<br />`sigin.vue` å’Œ `register.vue` ç»„ä»¶åˆ†åˆ«ä¿®æ”¹
```javascript
// sigin.vue
<template>
  <div>
    <button @click="onClick">ç™»å½•ç¡®è®¤</button>
  </div>
</template>

<script>
export default {
  name: "Sigin",
  emits: ['sigin'],
  setup(props, { emit }) {
    const onClick = () => {
      emit("sigin")
    }
    return {
      onClick
    }
  }
};
</script>

// register.vue
<template>
  <button @click="onClick">æ³¨å†Œç¡®è®¤</button>
</template>

<script>
export default {
  name: "Register",
  emits: ['register'],
  setup(props, { emit }) {
    const onClick = () => {
      emit("register")
    }
    return {
      onClick
    }
  }
};
</script>

```
`index.vue` ç»„ä»¶
```javascript
<template>
  <div v-show="show">
    <Sigin v-if="type === 'sigin'" @sigin="loginCallback" />
    <Register v-if="type === 'register'" @register="loginCallback" />
  </div>
</template>

<script>
import Sigin from "./sigin.vue";
import Register from "./register.vue";
import { ref } from 'vue';
export default {
  components: {
    Register,
    Sigin
  },
  props: {
    visible: Boolean,
    type: String,
    close: [Function, Boolean]
  },
  emits: ['destroy'],
  setup(props, { emit }) {
    const show = ref(props.visible);
    const doClose = () => {
      show.value = false;
      emit('destroy');
    }

    const loginCallback = () => {
      if (!props.close) return;
      props.close().then(valid => {
        if (valid) {
          doClose();
        }
      });
    }

    return {
      show,
      doClose,
      loginCallback
    }
  }
};
</script>

```
<a name="tU8GO"></a>
## å­ç±»
ç”±äº `Vue.extend` è¢«åºŸå¼ƒï¼Œ`Vue 3` è¿™é‡Œä½¿ç”¨ `h` å’Œ `render` ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°ä»‹ç»ï¼Œå…·ä½“ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥æŸ¥çœ‹[æ–‡æ¡£](https://vue3js.cn/docs/zh/api/global-api.html#%E7%B1%BB%E5%9E%8B%E5%A3%B0%E6%98%8E)

- `h` å‡½æ•°å‚æ•°ï¼š
   -  `type` å®ƒçš„ç±»å‹å¯ä»¥æ˜¯HTML æ ‡ç­¾åã€ç»„ä»¶æˆ–å¼‚æ­¥ç»„ä»¶
   -  `props` æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æˆ‘ä»¬æ¨¡æ¿ç»„ä»¶å†…çš„ `attribute`ã€`prop`ã€äº‹ä»¶ç›¸å¯¹åº”
- `render` æ¸²æŸ“å‡½æ•°æ¥æ”¶ä¸€ä¸ªç»„ä»¶å’Œå®¹å™¨



ä¿®æ”¹ `index.js`
```javascript
import { render, h } from "vue";
import ModalCops from "./index.vue"; 

let instance;

const ModalBox = ({type, ok}) => {
  if (instance) {
    instance.component.proxy.doClose();
  }

  // ç»„ä»¶æ¥æ”¶çš„ props
  let _opt = {
    visible: true,
    type,
    close: () => {
      return new Promise(resolve => {
        const before = ok ? ok() : false;

        if (before && before.then) {
          before.then(
            () => resolve(true),
            () => {
              console.log("reject");
            }
          );
        } else if (typeof before === "boolean" && before !== false) {
          resolve(true);
        }
      });
    }
  };

  instance = h(ModalCops, _opt); // ç»„ä»¶

  const container = document.createElement('div');

  // ç»„ä»¶é”€æ¯æ—¶
  instance.props.onDestroy = () => {
    render(null, container);
  }

  // æ¸²æŸ“ç»„ä»¶
  render(instance, container);
  
  // å°†æ¨¡æ€æ¡†æ·»åŠ è‡³ body
  document.body.appendChild(container.firstElementChild);

};

ModalBox.sigin = ok => {
  return ModalBox({
    type: "sigin",
    ok
  });
};

ModalBox.register = ok => {
  return ModalBox({
    type: "register",
    ok
  });
};

ModalBox.close = () => {
  instance.component.proxy.doClose();
  instance.component.proxy.show = false;
};

export default {
  install(app) {
    app.config.globalProperties.$loginer = ModalBox;
  }
};

```
æœ€ååœ¨å…¨å±€æŒ‚è½½
```javascript
import { createApp } from 'vue'
import Login from './Login.vue'
import LoginModal from "./LoginModal/index.js";
createApp(Login).use(LoginModal).mount('#app')
```
`Login.vue` ç»„ä»¶ä¸­ä½¿ç”¨
```javascript
import { ref, getCurrentInstance } from "vue";
export default {
  setup(props) {
    const { proxy } = getCurrentInstance();

    const isOk = ref(true);

    const onLogin = (type) => {
      const funcs = {
        sigin: () => {
          console.log("ç™»å½•è¯·æ±‚");
        },
        register: () => {
          console.log("æ³¨å†Œè¯·æ±‚");
        },
      };
      proxy.$loginer({
        type,
        ok: () => {
          return new Promise((resolve, reject) => {
            if (isOk.value) {
              funcs[type]();
              resolve();
            } else {
              reject();
            }
          });
        },
      });
    };

    return {
      isOk,
      onLogin,
    };
  },
};
```
æœ€åè¿˜æ˜¯æ”¾ä¸€ä¸‹æ•ˆæœ

![logo.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/04ac24b78eb64374b11306d73068a8a7~tplv-k3u1fbpfcp-zoom-1.image)
<a name="QSlHk"></a>
## æ³¨æ„
åœ¨ä¿®æ”¹å…¶ä¸­çš„éƒ¨åˆ†ä»£ç æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„å‡ ä¸ªç‚¹

- å…¨å±€æŒ‚è½½

`Vue 3` è¿˜æ˜¯æä¾› `use` å‡½æ•°ï¼Œæ¥ä½¿ç”¨æˆ‘ä»¬çš„æ’ä»¶ï¼Œä¸è¿‡éœ€è¦æŒ‚è½½çš„å±æ€§å˜äº†ï¼Œä¸å†æ˜¯ç›´æ¥æŒ‚è½½åœ¨ `Vue.prototype` ä¸Šï¼Œè€Œæ˜¯éœ€è¦æ·»åŠ åˆ°å…¨å±€å®ä¾‹çš„ `config.globalProperties` å¯¹è±¡ä¸Š
```javascript
  install(app) {
    app.config.globalProperties.$loginer = ModalBox;
  }
```

- ç»„ä»¶é”€æ¯æ—¶çš„ `onDestroy` äº‹ä»¶

è¿™ä¸ªäº‹ä»¶å¯¹åº”äº† `index.vue` æ¨¡æ¿ç»„ä»¶ä¸­ `emit` å‡ºçš„ `destroy` äº‹ä»¶ï¼Œè¿™æ˜¯ç”±äº `Vue` æºç ä¸­ `packages\runtime-core\src\componentEmits.ts` ä¸­`emit` å‡½æ•°ç»™æˆ‘ä»¬äº‹ä»¶è‡ªåŠ¨åŠ ä¸Šäº† `on` å‰ç¼€<br />![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b830a8c0ad04c6185b170d85bf2ffb2~tplv-k3u1fbpfcp-zoom-1.image)<br />

## æ€»ç»“
å­¦äº†å°±è¦ç”¨ã€‚æœ¬æ¬¡æ˜¯åœ¨å­¦ä¹  `Vue3` åå°±åœ¨é¡¹ç›®ä¸­å…¨é¢ä½¿ç”¨ï¼Œå…¶ä¸­ä¹Ÿç¢°åˆ°ä¸å°‘éœ€è¦è§„é¿çš„å‘ï¼Œä¹Ÿå°è¯•ç€é˜…è¯»éƒ¨åˆ†æºç ï¼Œæ”¶è·æ»¡æ»¡ğŸ˜

æœ¬æ–‡æ­£åœ¨å‚ä¸ã€Œæ˜é‡‘ 2021 æ˜¥æ‹›é—¯å…³æ´»åŠ¨ã€, ç‚¹å‡»æŸ¥çœ‹ [æ´»åŠ¨è¯¦æƒ…](https://juejin.cn/post/6939329638506168334/)

